@page "/soilMoistureChart"
@using System.Text.Json
@inject Services.MqttService MqttService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<h3>Real-Time Sensor Data</h3>
<canvas id="sensorChart" width="400" height="200"></canvas>

@code {
    private string mqttAddress;
    private int mqttPort;
    private string mqttTopic;
    private List<float> temperatureData = new List<float>();
    private List<float> humidityData = new List<float>();
    private List<int> soilMoistureData = new List<int>();

    protected override async Task OnInitializedAsync()
    {
        // Query String에서 MQTT 정보 가져오기
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        mqttAddress = query["mqttAddress"];
        mqttPort = int.Parse(query["mqttPort"]);
        mqttTopic = query["mqttTopic"];

        // MQTT 메시지 수신 핸들러 등록
        MqttService.OnMessageReceived += HandleMqttMessage;

        // MQTT 브로커에 연결
        await MqttService.ConnectAsync(mqttAddress, mqttPort);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // JavaScript로 차트 초기화
            await JSRuntime.InvokeVoidAsync("initializeChart");
        }
    }

    private async void HandleMqttMessage(string topic, string message)
    {
        var sensorData = JsonSerializer.Deserialize<SensorData>(message);

        if (sensorData != null)
        {
            temperatureData.Add(sensorData.Temperature);
            humidityData.Add(sensorData.Humidity);
            soilMoistureData.Add(sensorData.SoilMoisture);

            if (temperatureData.Count > 10)
            {
                temperatureData.RemoveAt(0);
                humidityData.RemoveAt(0);
                soilMoistureData.RemoveAt(0);
            }

            // 차트를 업데이트
            await UpdateChart();
        }
    }

    private async Task UpdateChart()
    {
        // JavaScript로 차트를 업데이트
        await JSRuntime.InvokeVoidAsync("updateChart", temperatureData.ToArray(), humidityData.ToArray(), soilMoistureData.ToArray());
    }

    public void Dispose()
    {
        // MQTT 메시지 수신 핸들러 제거
        MqttService.OnMessageReceived -= HandleMqttMessage;

        // JavaScript에서 차트를 안전하게 정리
        JSRuntime.InvokeVoidAsync("disposeChart");
    }

    public class SensorData
    {
        public float Temperature { get; set; }
        public float Humidity { get; set; }
        public int SoilMoisture { get; set; }
    }
}
