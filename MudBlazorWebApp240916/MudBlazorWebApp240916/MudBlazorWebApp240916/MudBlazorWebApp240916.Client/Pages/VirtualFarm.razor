@page "/VirtualFarm"
@inject IJSRuntime JSRuntime

<MudContainer>
    <MudItem xs="12">
        <MudPaper>
            <h3>3D Dashboard</h3>
            <div id="unity-container" class="unity-desktop" style="width: 960px; height: 600px;">
                <canvas id="unity-canvas" width="1280" height="960"></canvas>
                <div id="unity-loading-bar" style="display:none;">
                    <div id="unity-logo"></div>
                    <div id="unity-progress-bar-empty">
                        <div id="unity-progress-bar-full"></div>
                    </div>
                </div>
                <div id="unity-warning"></div>
                <div id="unity-footer">
                    <div id="unity-webgl-logo"></div>
                    <div id="unity-fullscreen-button"></div>
                    <div id="unity-build-title">farmTest240531</div>
                </div>
            </div>
        </MudPaper>
    </MudItem>
</MudContainer>

@code {
    protected override async Task OnAfterRenderAsync (bool firstRender)
    {
        if (firstRender)
        {
            // unityLoader.js 파일을 로드하고 Unity를 초기화합니다.
            await JSRuntime.InvokeVoidAsync("eval", $@"
                var container = document.querySelector('#unity-container');
                var canvas = document.querySelector('#unity-canvas');
                var loadingBar = document.querySelector('#unity-loading-bar');
                var progressBarFull = document.querySelector('#unity-progress-bar-full');
                var fullscreenButton = document.querySelector('#unity-fullscreen-button');
                var warningBanner = document.querySelector('#unity-warning');

                function unityShowBanner(msg, type) {{
                    var div = document.createElement('div');
                    div.innerHTML = msg;
                    warningBanner.appendChild(div);
                    if (type === 'error') div.style = 'background: red; padding: 10px;';
                    else if (type === 'warning') div.style = 'background: yellow; padding: 10px;';
                    setTimeout(function() {{
                        warningBanner.removeChild(div);
                    }}, 5000);
                }}

                var buildUrl = 'Build';
                var loaderUrl = buildUrl + '/wwwroot.loader.js';
                var config = {{
                    dataUrl: buildUrl + '/wwwroot.data.txt',
                    frameworkUrl: buildUrl + '/wwwroot.framework.js',
                    codeUrl: buildUrl + '/wwwroot.wasm',
                    streamingAssetsUrl: 'StreamingAssets',
                    companyName: 'DefaultCompany',
                    productName: 'farmTest240531',
                    productVersion: '0.1',
                    showBanner: unityShowBanner,
                }};

                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {{
                    container.className = 'unity-mobile';
                    config.devicePixelRatio = 1;
                    unityShowBanner('WebGL builds are not supported on mobile devices.');
                }} else {{
                    canvas.style.width = '1280px';
                    canvas.style.height = '960px';
                }}
                loadingBar.style.display = 'block';

                var script = document.createElement('script');
                script.src = loaderUrl;
                script.onload = function() {{
                    createUnityInstance(canvas, config, function(progress) {{
                        progressBarFull.style.width = (100 * progress) + '%';
                    }}).then(function(unityInstance) {{
                        loadingBar.style.display = 'none';
                        fullscreenButton.onclick = function() {{
                            unityInstance.SetFullscreen(1);
                        }};
                    }}).catch(function(message) {{
                        alert(message);
                    }});
                }};
                document.body.appendChild(script);
            ");
        }
    }
}